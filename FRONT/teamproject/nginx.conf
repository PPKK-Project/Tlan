# # 80 포트 서버: HTTP 요청을 HTTPS로 리디렉션
# server {
#     listen 80;
#     server_name tlan.kro.kr;

#     # Certbot 도메인 소유권 인증을 위한 경로
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # 그 외 모든 HTTP 요청은 HTTPS로 리디렉션
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }

# # 443 포트 서버: 실제 HTTPS 서비스
# server {
#     listen 443 ssl;
#     server_name tlan.kro.kr;

#     # SSL 인증서 경로
#     ssl_certificate /etc/letsencrypt/live/tlan.kro.kr/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/tlan.kro.kr/privkey.pem;

#     # SSL 관련 권장 설정
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

#     root   /usr/share/nginx/html; # 모든 정적 파일의 기본 위치 설정
#     index  index.html;

#     # Certbot 도메인 소유권 인증을 위한 경로
#     # Let's Encrypt가 http://tlan.kro.kr/.well-known/acme-challenge/xxxx 에 접속하여 인증 파일을 확인합니다.
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # 1. Nginx: 프론트엔드의 잘못된 경로(api/assets/...)를 직접 처리 (500 오류 방지)
#     # 이 블록은 정규식으로 처리되므로, /api/assets/ 요청이 2번 블록보다 먼저 잡힙니다.
#     location ~ ^/api/(assets/.*|vite\.svg)$ {
#         # 요청 URL에서 '/api/' 접두사를 제거하고 내부적으로 경로를 재작성합니다.
#         rewrite ^/api/(.*)$ /$1 break; 
        
#         # 재작성된 경로(/assets/...)를 root(/usr/share/nginx/html)에서 찾아서 제공합니다.
#         try_files $uri =404;
#     }

#     # 2. Nginx: 실제 API 요청만 백엔드로 프록시 (프론트엔드에서 /api/를 붙여서 호출하는 경우)
#     location /api/ {
#         # /api/ 접두사를 제거하고 백엔드로 전달합니다.
#         # 예: /api/travels/1 -> /travels/1 (백엔드 엔드포인트와 일치)
#         rewrite ^/api/(.*)$ /$1 break; 
        
#         # 재작성된 경로(/travels/1)를 백엔드 8080 포트에 전달합니다.
#         proxy_pass http://spring-boot-app:8080; 
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
    
#     # 2.5. **루트 경로에서 직접 요청하는 API 엔드포인트 처리** (주소창 /currency 시)
#     location ~ ^/(countries|embassy|place|currency|travels|login|signup) {
#         # 이 블록은 경로를 rewrite하지 않고 그대로 백엔드에 포워딩합니다. (백엔드 엔드포인트와 일치)
#         proxy_pass http://spring-boot-app:8080;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }


#     # 3. Nginx: SPA (Single Page Application) 폴백 처리
#     location / {
#         # 1, 2, 2.5에 해당하지 않는 모든 요청은 index.html로 폴백하여 화면을 로드합니다.
#         try_files $uri $uri/ /index.html; 
#     }

#     # KOSIS API 프록시 (기존 설정 유지)
#     location /kosis/ {
#         rewrite ^/kosis/(.*)$ /$1 break;
#         proxy_pass https://kosis.kr/;
#         proxy_set_header Host kosis.kr;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }

#     # STOMP WebSocket 프록시 (기존 설정 유지)
#     location /ws-stomp {
#         proxy_pass http://spring-boot-app:8080/ws-stomp; 
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }

#     # 4. 에러 페이지 (선택 사항)
#     error_page 500 502 503 504 /50x.html;
#     location = /50x.html {
#         root   /usr/share/nginx/html;
#     }
# }




# 1단계: Certbot 인증을 위한 임시 설정
server {
    listen 80;
    server_name tlan.kro.kr;

    # Certbot 도메인 소유권 인증을 위한 경로
    # Let's Encrypt가 http://tlan.kro.kr/.well-known/acme-challenge/ 에 접속하여 인증 파일을 확인합니다.
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Certbot 인증 중에는 다른 모든 요청에 대해 임시로 200 OK를 반환하여
    # 사이트가 동작하는 것처럼 보이게 합니다 (필수 사항은 아님).
    location / {
        return 200 'Certbot validation in progress...';
    }
}

